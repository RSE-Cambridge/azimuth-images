#!/usr/bin/env bash

#####
# This script purges images from OpenStack and S3 after a CI run
#####

set -eo pipefail

REPO_ROOT="$(dirname $(dirname $(realpath ${BASH_SOURCE[0]:-${(%):-%x}})))"
source "$REPO_ROOT/bin/env-vars"

cat <<EOF > ~/.s3cfg
host_base = ${S3_HOST}
host_bucket = ${S3_HOST_BUCKET:-"$S3_HOST"}
access_key = ${S3_ACCESS_KEY}
secret_key = ${S3_SECRET_KEY}
use_https = True
EOF

echo "[INFO] fetching manifest - $1"
manifest="$(s3cmd get --no-progress "s3://$S3_BUCKET/$1" -)"

for name in $(jq -r '.[] | .name' <<< "$manifest"); do
  echo "[INFO] purging image - $name"

  echo "[INFO]   removing image from OpenStack"
  openstack image delete "$name"

  echo "[INFO]   removing image from S3"
  s3cmd del "s3://$S3_BUCKET/$name.qcow2"
done

echo "[INFO] removing manifest"
s3cmd del "s3://$S3_BUCKET/$1"
